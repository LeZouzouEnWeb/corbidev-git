name: âœ… CI â€“ Build & Tests (PR)

on:
  pull_request:
    branches: [ develop ]   # change si besoin

concurrency:
  group: ci-pr-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  php:
    name: PHP / Composer / Tests
    runs-on: ubuntu-latest
    if: ${{ hashFiles('composer.json') != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: ğŸ§° Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer:v2
          extensions: mbstring, intl, xml, ctype, json, pdo_mysql

      - name: ğŸ§± Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: ğŸ“¦ Composer install (no-dev en PR ? Ã  toi de voir)
        run: composer install --no-interaction --prefer-dist

      - name: ğŸ” PHPCS (si ruleset prÃ©sent)
        if: ${{ hashFiles('phpcs.xml*') != '' }}
        run: |
          vendor/bin/phpcs --version
          vendor/bin/phpcs -q

      - name: ğŸ§ª PHPUnit (si config prÃ©sente)
        if: ${{ hashFiles('phpunit.xml*') != '' }}
        run: |
          vendor/bin/phpunit --version
          vendor/bin/phpunit

  node:
    name: Node / Build / Tests
    runs-on: ubuntu-latest
    if: ${{ hashFiles('package.json') != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: ğŸ§° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: ğŸ“¦ Install deps
        run: npm ci

      - name: ğŸ§ª Tests (si script dÃ©fini)
        if: ${{ contains(join(fromJSON('["", inputs]')), '') || always() }} # garde l'Ã©tape, mais elle ne fail que si script existe et Ã©choue
        run: |
          if npm run | grep -qE ' test'; then
            npm test --ignore-scripts=false
          else
            echo "No test script"
          fi

      - name: ğŸ—ï¸ Build (si script dÃ©fini)
        run: |
          if npm run | grep -qE ' build'; then
            npm run build
          else
            echo "No build script"
          fi