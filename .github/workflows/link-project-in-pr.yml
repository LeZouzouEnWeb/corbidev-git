name: ðŸ”— Lier le projet a la PR

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: write  # âœ… clÃ© valide (Ã©vite "Unexpected value 'projects'")

jobs:
  link:
    runs-on: ubuntu-latest
    steps:
      - name: Link PR to issue and copy Projects
        uses: actions/github-script@v7
        env:                     # âœ… env au niveau du step (pas sous `with`)
          PR_KEYWORD: Closes
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNumber = pr.number;

            // 1) extraire le numÃ©ro de ticket depuis titre, branche ou body
            const title = pr.title || "";
            const branch = pr.head?.ref || "";
            const body = pr.body || "";

            // Exemples acceptÃ©s : [#88], #88, ticket-88, ticket_88, ticket/88
            const rxList = [
              /\[#?(\d+)\]/i,
              /(?:^|\s)#(\d+)(?:\s|$)/,
              /ticket[-_\/]?(\d+)/i
            ];
            let ticket = null;
            for (const rx of rxList) {
              const m = title.match(rx) || branch.match(rx) || body.match(rx);
              if (m && m[1]) { ticket = parseInt(m[1], 10); break; }
            }
            if (!ticket) {
              core.setFailed("Aucun numÃ©ro de ticket trouvÃ© dans le titre, la branche ou la description.");
              return;
            }

            // 2) vÃ©rifier que lâ€™issue existe
            let issue;
            try {
              const { data } = await github.rest.issues.get({ owner, repo, issue_number: ticket });
              issue = data;
            } catch (e) {
              core.setFailed(`Issue #${ticket} introuvable dans ${owner}/${repo}.`);
              return;
            }

            // 3) Sâ€™assurer que la PR mentionne lâ€™issue (mot-clÃ© configurable)
            const CLOSING_KEYWORD = process.env.PR_KEYWORD || "Closes";
            if (!new RegExp(`\\b(#${ticket})\\b`).test(body)) {
              const newBody = (body ? body + "\n\n" : "") + `${CLOSING_KEYWORD} #${ticket}`;
              await github.rest.pulls.update({ owner, repo, pull_number: prNumber, body: newBody });
              core.info(`PR body mis Ã  jour avec "${CLOSING_KEYWORD} #${ticket}".`);
            }

            // 4) RÃ©cupÃ©rer lâ€™ID GraphQL de la PR et les Project(s) de lâ€™issue
            const query = `
              query($owner:String!, $repo:String!, $prNumber:Int!, $issueNumber:Int!) {
                repository(owner:$owner, name:$repo) {
                  pullRequest(number:$prNumber) { id }
                  issue(number:$issueNumber) {
                    id
                    projectsV2(first: 20) { nodes { id title } }
                  }
                }
              }
            `;
            const qres = await github.graphql(query, { owner, repo, prNumber, issueNumber: ticket });
            const prId = qres.repository.pullRequest?.id;
            const projects = qres.repository.issue?.projectsV2?.nodes || [];
            if (!prId) {
              core.setFailed("Impossible de rÃ©cupÃ©rer lâ€™ID de la PR.");
              return;
            }
            if (projects.length === 0) {
              core.info(`Lâ€™issue #${ticket} nâ€™est dans aucun Project v2 ; rien Ã  copier.`);
              return;
            }

            // 5) Ajouter la PR Ã  chacun des mÃªmes Projects v2
            const mutation = `
              mutation($projectId:ID!, $contentId:ID!) {
                addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}) {
                  item { id }
                }
              }
            `;
            for (const p of projects) {
              try {
                await github.graphql(mutation, { projectId: p.id, contentId: prId });
                core.info(`PR ajoutÃ©e au Project: ${p.title}`);
              } catch (err) {
                core.warning(`DÃ©jÃ  prÃ©sent ou non ajoutÃ©e dans "${p.title}" : ${err.message}`);
              }
            }

            core.notice(`PR #${prNumber} liÃ©e Ã  #${ticket} et copiÃ©e vers ${projects.length} project(s).`);