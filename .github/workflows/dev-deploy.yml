
name: üöÄ Deploy DEV (IONOS SFTP)

on:
  pull_request:
    branches: [ develop ]
    types: [ closed ]
  push:
    branches: [ develop ]   # supprime ce bloc si tu veux d√©clencher uniquement apr√®s merge

concurrency:
  group: deploy-develop
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }

      - name: üîê Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîß Construire le chemin distant normalis√©
        id: build_path
        env:
          REMOTE_CHEMIN: ${{ secrets.REMOTE_CHEMIN }}
          ADRESSE_GLOBAL: ${{ vars.ADRESSE_GLOBAL }}
          ADRESSE_LOCAL: ${{ vars.ADRESSE_LOCAL }}
        run: |
          set -euo pipefail

          echo "Trace> REMOTE_CHEMIN='${REMOTE_CHEMIN:-}'"
          echo "Trace> ADRESSE_GLOBAL='${ADRESSE_GLOBAL:-}'"
          echo "Trace> ADRESSE_LOCAL='${ADRESSE_LOCAL:-}'"

          if [ -z "${REMOTE_CHEMIN:-}" ]; then
            echo "::error title=REMOTE_CHEMIN manquant::D√©finis REMOTE_CHEMIN dans Settings ‚Üí Secrets."
            exit 1
          fi
          if [ "${REMOTE_CHEMIN}" = "/" ]; then
            echo "::error title=REMOTE_CHEMIN invalide::REMOTE_CHEMIN ne peut pas √™tre '/'. Mets le chemin absolu vers ton htdocs (ex: /homepages/xx/dxxxx/htdocs)."
            exit 1
          fi
          if [ -z "${ADRESSE_GLOBAL:-}" ] || [ -z "${ADRESSE_LOCAL:-}" ]; then
            echo "::error title=Variables manquantes::ADRESSE_GLOBAL et ADRESSE_LOCAL doivent √™tre d√©finies (Settings ‚Üí Variables)."
            exit 1
          fi

          REMOTE_PATH="${REMOTE_CHEMIN%/}/${ADRESSE_GLOBAL%/}/dev/${ADRESSE_LOCAL#/}"
          # Nettoyage pour √©viter les doubles //
          REMOTE_PATH="$(printf '%s' "$REMOTE_PATH" | sed -E 's:/+:/:g')"

          echo "Trace> REMOTE_PATH construit = $REMOTE_PATH"
          echo "REMOTE_PATH=$REMOTE_PATH" >> "$GITHUB_OUTPUT"

      - name: üîå Tester la connexion SSH
        run: |
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "echo 'SSH OK: ' \$(hostname)"

      - name: üìÅ S'assurer que le dossier existe
        run: |
          REMOTE_PATH="${{ steps.build_path.outputs.REMOTE_PATH }}"
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "mkdir -p -- \"$REMOTE_PATH\" \
             && echo '‚úÖ Dossier pr√™t: ' \"$REMOTE_PATH\" \
             && echo 'Parent:' \$(dirname \"$REMOTE_PATH\") \
             && ls -ld \$(dirname \"$REMOTE_PATH\") || true"

      - name: üöö Deploy via SFTP (incremental)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: .
          remote_path: ${{ steps.build_path.outputs.REMOTE_PATH }}
          exclude: |
            .git*
            .github/**
            node_modules/**
            .env*
            tests/**
            coverage/**
          args: "-rz"

      - name: üëÄ Lister le dossier d√©ploy√© (debug)
        run: |
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -la '${{ steps.build_path.outputs.REMOTE_PATH }}' || true"